<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <!-- Responsive Meta Tag -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>YouTube Sync - Host or Join</title>
  <style>
    /* Base Styles */
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      margin: 20px;
      background-color: #fff; /* White background */
      color: #000; /* Black text */
      user-select: none; /* Disable text selection */
    }
    .hidden {
      display: none;
    }
    button {
      padding: 10px 20px;
      font-size: 16px;
      margin: 10px;
      cursor: pointer;
      background-color: #000; /* Black button background */
      color: #fff; /* White text */
      border: none;
      border-radius: 5px;
      transition: transform 0.3s ease, background-color 0.3s ease;
    }
    button:hover {
      transform: scale(1.05);
      background-color: #333; /* Dark gray on hover */
    }
    input {
      padding: 10px;
      font-size: 16px;
      width: 300px;
      margin: 10px;
      border: 1px solid #000; /* Black border */
      border-radius: 5px;
      background-color: #fff;
      color: #000;
      transition: border-color 0.3s ease;
    }
    input:focus {
      border-color: #000;
      outline: none;
    }
    
    /* Animation Keyframes */
    @keyframes fadeIn {
      0% {
        opacity: 0;
        transform: translateY(20px);
      }
      100% {
        opacity: 1;
        transform: translateY(0);
      }
    }
    .animate {
      animation: fadeIn 0.6s ease-out;
    }
    
    /* Responsive YouTube Player Container */
    #player {
      position: relative;
      width: 100%;
      max-width: 640px;
      margin: 0 auto;
      padding-bottom: 56.25%; /* 16:9 aspect ratio */
    }
    #player iframe {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }
    
    /* Bubble Animation Container */
    #bubbles {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 150px; /* Bubbles will travel within this area */
      pointer-events: none;
      overflow: hidden;
      z-index: 999;
    }
    /* Bubble Styles */
    .bubble {
      position: absolute;
      bottom: 0;
      width: 20px;
      height: 20px;
      background-color: #000; /* Black bubbles */
      border-radius: 50%;
      opacity: 0;
      animation: bubbleFloat 4s linear infinite;
      animation-direction: normal;
      cursor: pointer;
      pointer-events: auto;
    }
    @keyframes bubbleFloat {
      0% {
        transform: translateY(0);
        opacity: 0;
      }
      30% {
        transform: translateY(-50px);
        opacity: 0.7;
      }
      70% {
        transform: translateY(-100px);
        opacity: 0.7;
      }
      100% {
        transform: translateY(-150px);
        opacity: 0;
      }
    }
    /* Pop Animation for Bubbles */
    .bubble.pop {
      animation: popBubble 0.5s forwards;
    }
    @keyframes popBubble {
      0% {
        transform: scale(1);
        opacity: 0.7;
      }
      100% {
        transform: scale(2);
        opacity: 0;
      }
    }
    
    /* Creator Quote Styles */
    #creatorQuote {
      position: fixed;
      bottom: 0;
      left: 0;
      padding: 5px 10px;
      font-size: 16px;
      color: #000;
      z-index: 1001;
    }
    
    /* Responsive Media Query */
    @media (max-width: 480px) {
      input {
        width: 90%;
      }
      button {
        width: 90%;
        font-size: 14px;
      }
    }
  </style>
</head>
<body>
  <h1>YouTube Sync</h1>

  <!-- Mode Selection -->
  <div id="modeSelection">
    <p>How would you like to connect?</p>
    <button id="hostBtn">Host a Room</button>
    <button id="joinBtn">Join a Room</button>
  </div>

  <!-- Host Section -->
  <div id="hostSection" class="hidden">
    <h2>Host Room</h2>
    <p>Your generated Room ID: <span id="hostRoomID"></span></p>
    <button id="startSyncHost">Start Sync</button>
  </div>

  <!-- Join Section -->
  <div id="joinSection" class="hidden">
    <h2>Join Room</h2>
    <input type="text" id="joinRoomInput" placeholder="Enter Room ID">
    <br>
    <button id="joinRoomBtn">Join Room</button>
    <p id="joinError" style="color: #ff4d4d;"></p>
  </div>

  <!-- Sync Section (common for host & join) -->
  <div id="syncSection" class="hidden">
    <h2>Sync Page</h2>
    <p>Room ID: <span id="syncRoomID"></span></p>
    <!-- Video Input Section -->
    <div id="videoInputSection">
      <input type="text" id="videoIdInput" placeholder="Enter YouTube Video ID" value="dQw4w9WgXcQ">
      <button id="loadVideoBtn">Load Video</button>
    </div>
    <!-- Responsive YouTube Player Container -->
    <div id="player" class="hidden"></div>
    <!-- The "Sync Now" button is only for host manual control (optional) -->
    <button id="syncNowBtn" class="hidden">Sync Now</button>
  </div>

  <!-- Bubble Container (bubbles are spawned dynamically) -->
  <div id="bubbles"></div>

  <!-- Creator Quote -->
  <div id="creatorQuote">Created by Fortune Adiat</div>

  <!-- Load YouTube IFrame API -->
  <script src="https://www.youtube.com/iframe_api"></script>
  <!-- Load Firebase (compat versions for simplicity) -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
  
  <script>
    // Disable right-click context menu to discourage text copying.
    document.addEventListener('contextmenu', function(e) {
      e.preventDefault();
    });

    // --- Firebase Initialization ---
    var firebaseConfig = {
apiKey: "AIzaSyBq-1QsqHNBdUCcUKRhBaqWpuwSnB1E1gU",
  authDomain: "church-bb0d0.firebaseapp.com",
  databaseURL: "https://church-bb0d0-default-rtdb.firebaseio.com",
  projectId: "church-bb0d0",
  storageBucket: "church-bb0d0.firebasestorage.app",
  messagingSenderId: "290990518536",
  appId: "1:290990518536:web:621741c497c5e4262efcbd",
    };
    firebase.initializeApp(firebaseConfig);
    var db = firebase.database();

    // --- Global Variables ---
    var roomId = "";
    var isHost = false;
    var player;
    var syncInterval; // For continuous syncing on host

    // --- Utility: Generate a short (4-character) room ID ---
    function generateShortRoomID() {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
      let result = '';
      for (let i = 0; i < 4; i++) {
        result += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return result;
    }

    // --- YouTube API: Called when the API is ready ---
    function onYouTubeIframeAPIReady() {
      console.log("YouTube IFrame API loaded.");
    }

    // --- Create YouTube Player ---
    function createPlayer(videoId) {
      var playerDiv = document.getElementById("player");
      playerDiv.classList.remove("hidden");
      playerDiv.classList.add("animate");
      // Show the Sync Now button only for host (if manual control is desired)
      document.getElementById("syncNowBtn").classList.toggle("hidden", !isHost);
      
      player = new YT.Player('player', {
        height: '100%',
        width: '100%',
        videoId: videoId,
        playerVars: {
          autoplay: 0,
          controls: 1
        },
        events: {
          'onReady': onPlayerReady,
          'onStateChange': onPlayerStateChange
        }
      });
    }

    function onPlayerReady(event) {
      console.log("YouTube Player is ready.");
      if (isHost) {
        // Start continuous sync every 200ms for tighter synchronization.
        if (player.getPlayerState() === YT.PlayerState.PLAYING) {
          if (syncInterval) clearInterval(syncInterval);
          syncInterval = setInterval(sendSyncCommand, 200);
        }
      }
    }

    // --- Host Player State Change Handler ---
    function onPlayerStateChange(event) {
      if (!isHost) return; // Only host sends updates
      // PLAYING = 1, PAUSED = 2, ENDED = 0
      if (event.data === YT.PlayerState.PLAYING) {
        console.log("Host playing");
        if (syncInterval) clearInterval(syncInterval);
        syncInterval = setInterval(sendSyncCommand, 200);
        db.ref("rooms/" + roomId).set({
          time: player.getCurrentTime(),
          state: "play"
        });
      } else if (event.data === YT.PlayerState.PAUSED || event.data === YT.PlayerState.ENDED) {
        console.log("Host paused or ended");
        if (syncInterval) {
          clearInterval(syncInterval);
          syncInterval = null;
        }
        db.ref("rooms/" + roomId).set({
          time: player.getCurrentTime(),
          state: "pause"
        });
      }
    }

    // --- Listen for Sync Updates (Joiner Only) ---
    function listenForSync() {
      var roomRef = db.ref("rooms/" + roomId);
      roomRef.on("value", function(snapshot) {
        var data = snapshot.val();
        // Only update joiner's player if joiner (isHost = false) and player is ready.
        if (data && player && !isHost) {
          console.log("Received sync data:", data);
          if (typeof data.time === "number") {
            // If the joiner's video is off by more than 0.5 seconds, seek to host's time.
            if (Math.abs(player.getCurrentTime() - data.time) > 0.4) {
              player.seekTo(data.time, true);
            }
          }
          if (data.state === "play") {
            player.playVideo();
          } else if (data.state === "pause") {
            player.pauseVideo();
          }
        }
      });
    }

    // --- Send Sync Command (Host Only) ---
    function sendSyncCommand() {
      if (player && isHost) {
        var currentTime = player.getCurrentTime();
        db.ref("rooms/" + roomId).set({
          time: currentTime,
          state: "play"
        });
        console.log("Sync command sent:", currentTime);
      }
    }

    // --- DOM Elements ---
    var modeSelectionDiv = document.getElementById("modeSelection");
    var hostSectionDiv = document.getElementById("hostSection");
    var joinSectionDiv = document.getElementById("joinSection");
    var syncSectionDiv = document.getElementById("syncSection");
    var videoInputSectionDiv = document.getElementById("videoInputSection");

    // --- Helper: Show a section with animation ---
    function showSection(section) {
      section.classList.remove("hidden");
      section.classList.add("animate");
    }

    // --- Mode Selection Event Handlers ---
    document.getElementById("hostBtn").addEventListener("click", function() {
      console.log("Host button clicked.");
      isHost = true;
      modeSelectionDiv.classList.add("hidden");
      showSection(hostSectionDiv);
      roomId = generateShortRoomID();
      console.log("Generated Room ID:", roomId);
      document.getElementById("hostRoomID").textContent = roomId;
      var roomRef = db.ref("rooms/" + roomId);
      roomRef.set({ created: true, timestamp: Date.now() })
        .then(() => {
          console.log("Room node created in Firebase.");
        })
        .catch((error) => {
          console.error("Error creating room node:", error);
        });
    });

    document.getElementById("joinBtn").addEventListener("click", function() {
      console.log("Join button clicked.");
      isHost = false;
      modeSelectionDiv.classList.add("hidden");
      showSection(joinSectionDiv);
    });

    // --- Join Section: Check and Join Room ---
    document.getElementById("joinRoomBtn").addEventListener("click", function() {
      var inputRoom = document.getElementById("joinRoomInput").value.trim();
      if (inputRoom === "") {
        document.getElementById("joinError").textContent = "Please enter a Room ID.";
        return;
      }
      var roomRef = db.ref("rooms/" + inputRoom);
      roomRef.once("value").then(function(snapshot) {
        if (snapshot.exists()) {
          console.log("Room exists. Joining room:", inputRoom);
          roomId = inputRoom;
          joinSectionDiv.classList.add("hidden");
          showSyncSection();
        } else {
          document.getElementById("joinError").textContent = "This room does not exist. Please check the Room ID or ask the host to create it.";
        }
      }).catch(function(error) {
        console.error("Error checking room:", error);
        document.getElementById("joinError").textContent = "Error checking room. Please try again.";
      });
    });

    // --- Host Section: Start Sync ---
    document.getElementById("startSyncHost").addEventListener("click", function() {
      console.log("Start Sync (host) clicked.");
      hostSectionDiv.classList.add("hidden");
      showSyncSection();
    });

    // --- Display Sync Section ---
    function showSyncSection() {
      showSection(syncSectionDiv);
      document.getElementById("syncRoomID").textContent = roomId;
      if (!isHost) {
        listenForSync();
      }
    }

    // --- Load Video Button in Sync Section ---
    document.getElementById("loadVideoBtn").addEventListener("click", function() {
      var videoId = document.getElementById("videoIdInput").value.trim();
      if (videoId) {
        createPlayer(videoId);
        videoInputSectionDiv.classList.add("hidden");
        console.log("Loading YouTube Video ID:", videoId);
      } else {
        alert("Please enter a valid YouTube Video ID.");
      }
    });

    // --- Sync Now Button (only for host, if manual sync is desired) ---
    document.getElementById("syncNowBtn").addEventListener("click", function() {
      sendSyncCommand();
    });

    // --- Dynamic Bubble Spawning Functionality ---
    function spawnBubble() {
      var bubble = document.createElement('div');
      bubble.className = 'bubble';
      // Randomize left position (0% to 100%)
      var left = Math.random() * 100;
      bubble.style.left = left + '%';
      // Randomize animation delay (0 to 3 seconds)
      var delay = Math.random() * 3;
      bubble.style.animationDelay = delay + 's';
      // Randomize animation duration (3 to 5 seconds)
      var duration = 3 + Math.random() * 2;
      bubble.style.animationDuration = duration + 's';
      // Append bubble to container
      var container = document.getElementById('bubbles');
      container.appendChild(bubble);
      // Remove bubble after its cycle (duration + delay)
      setTimeout(function() {
        if (bubble.parentNode) {
          bubble.remove();
        }
      }, (duration + delay) * 1000);
      // Add click event to pop the bubble
      bubble.addEventListener('click', function(e) {
        e.stopPropagation();
        if (!bubble.classList.contains('pop')) {
          bubble.classList.add('pop');
          setTimeout(function() {
            bubble.remove();
          }, 500);
        }
      });
    }

    // Spawn a new bubble every 1 second
    setInterval(spawnBubble, 1000);
  </script>
</body>
</html>
